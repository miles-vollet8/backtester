#include <cstdio>
#include<vector>
#include <iostream>
#include <nlopt.h>
#include <cmath>
#include "garch.hpp"
const double pi = 3.14159265358979323846;

struct GarchData {
    std::vector<double> returns;
};

double calculate_mean(const std::vector<double>& returns){

    size_t n = returns.size();
    if (n == 0){
        return 0.0f;
    }
    

    
    double sum = 0.0f;

    for (int i=0;i<int(n);i++){
        sum +=returns[i];
        
    }
    double mean = sum/double(n);

    return mean;
}


double calc_variance(const std::vector<double>& returns){
    double mean = calculate_mean(returns);
    double sum = 0.0f;
    size_t n = returns.size();
    double hold;
    for (unsigned int i = 0;i<n;i++){
        hold = returns[i] - mean;
        sum += (hold*hold);
    }
    double var = sum/(double(n) - 1.0f);
    return var;
}



double log_likelihood(const std::vector<double>& returns, const std::vector<double>  x){

    double w = x[0];
    double alpha = x[1];
    double beta = x[2];

    
    size_t n = returns.size();
    double intitial_sigma2 = calc_variance(returns);

    std::vector<double> sigma2(n);
    sigma2[0] = intitial_sigma2;
    double current_sigma2;
    for (unsigned int i = 1;i<n;i++){
        current_sigma2 = w + alpha*(returns[i-1]*returns[i-1]) + beta*(sigma2[i-1]);
        
        sigma2[i] = current_sigma2;
        if (sigma2[i] <= 1e-8 || std::isnan(sigma2[i]) || std::isinf(sigma2[i])) {
            std::cerr << "Bad sigma² at i = " << i << ", value = " << sigma2[i] << "\n";
            

            return 1e10;
        }
    }
    double likelihood = 0.0;
    for (unsigned int i = 0;i<n;i++){
        likelihood += -0.5*(std::log(2*pi)+std::log(sigma2[i]) + ((returns[i]*returns[i])/sigma2[i]));
    }
    return -likelihood;


}

double stationarity_constraint(unsigned n, const double *x, double *grad, void *data) {
    return x[1] - x[2] - 1.0; // x[1] = alpha, x[2] = beta
}


double garch_wrapper_og(unsigned int n, const double* x, double* grad, void *data){
    GarchData *dat = static_cast<GarchData*>(data);
    const std::vector<double> params(x, x+n);
    return log_likelihood(dat->returns, params);
}

double garch_wrapper(unsigned m, const double* x, double* grad, void* data) {
    // x = [p0, u, v]
    double ω  = std::exp(x[0]);
    double eu = std::exp(x[1]);
    double ev = std::exp(x[2]);
    double denom = 1.0 + eu + ev;
    double α  = eu / denom;
    double β  = ev / denom;

    // call your existing log_likelihood(returns, {ω,α,β})
    GarchData* ctx = static_cast<GarchData*>(data);
    std::vector<double> params = { ω, α, β };
    return log_likelihood(ctx->returns, params);
}


double optimize_params_og(const std::vector<double>& returns, std::vector<double>& x) {

    nlopt_opt opt = nlopt_create(NLOPT_LN_COBYLA, 3);
    GarchData ctx;
    ctx.returns = returns;     
    nlopt_set_min_objective(opt, garch_wrapper, &ctx);

    std::vector<double> lower_bounds = {1e-8, 1e-3, 1e-3};
    nlopt_set_lower_bounds(opt, lower_bounds.data());

    //std::vector<double> upper_bounds = {1e-4, 0.95, 0.95};
    double returns_var = calc_variance(returns);
    std::vector<double> upper_bounds = {returns_var, 0.999, 0.999};
    nlopt_set_upper_bounds(opt, upper_bounds.data());
    
    nlopt_add_inequality_constraint(opt, stationarity_constraint, nullptr, 1e-4);


//    nlopt_set_maxeval(opt, 200);
    nlopt_set_xtol_rel(opt, 1e-5);
    nlopt_set_ftol_rel(opt, 1e-5);
    double minf;
    

    nlopt_result result = nlopt_optimize(opt, x.data(), &minf);
    if (result <0){
        std::cerr << "NLOpt failed with code" << result << "\n";
    }

    nlopt_destroy(opt);

    return minf;
}

double optimize_params(const std::vector<double>& returns, std::vector<double>& x_raw) {
    GarchData ctx{returns};

    // 1) pick your algorithm (no bounds/constraints needed any more)
    nlopt_opt opt = nlopt_create(NLOPT_LN_BOBYQA, /*dim=*/3);

    // 2) set the new raw‐wrapper
    nlopt_set_min_objective(opt, garch_wrapper, &ctx);

    // 3) initial‐guess for p0,u,v based on sample var and desired α≈0.05,β≈0.9
    double sv = calc_variance(returns);
    double p0 = std::log(sv);
    double u  = std::log(0.05/(1 - 0.05 - 0.9));  // = log(1)
    double v  = std::log(0.9 /(1 - 0.05 - 0.9));  // = log(18)
    x_raw = { p0, u, v };

    // 4) tolerances as before
    nlopt_set_xtol_rel(opt, 1e-6);
    nlopt_set_ftol_rel(opt, 1e-6);

    double minf;
    nlopt_optimize(opt, x_raw.data(), &minf);
    nlopt_destroy(opt);
    return minf;
}


std::vector<double> calculated_sigma2(std::vector<double>& returns, std::vector<double> x ){
    size_t n = returns.size();
    double w = x[0];
    double alpha = x[1];
    double beta = x[2];


    std::vector<double> sigmas(n);
    double denom = 1.0 - alpha - beta;
    if (denom <= 0.0) {
        std::cerr << "Unstable GARCH params: alpha+beta = " 
                << (alpha+beta) << "\n";
        return {};  // or throw
    }
    sigmas[0] = w / denom;

    for (unsigned int i = 0;i<n-1;i++){
        sigmas[i+1] = w + alpha*(returns[i]*returns[i]) + beta*(sigmas[i]);
    }
    return sigmas;
    
}

double forecast_iv(std::vector<double> sigmas, std::vector<double> x, int h){
    size_t n = sigmas.size();
    double w = x[0];
    double alpha = x[1];
    double beta = x[2];
    double phi = alpha + beta;
    double sigma = sigmas.back();
    
    double var_sum = 0.0;
    double forecast = 0.0;
    
    for (unsigned int j = 1;j<=h;++j){
        sigma = (sigma * phi) + w;
        var_sum += sigma;
 
    }
    double avg_var = var_sum / h;
    double iv = std::sqrt(avg_var);
    iv  *= std::sqrt(252.0);
    return iv;

}


// int main() {
//     // 1) Prepare your returns vector
//     std::vector<double> returns = {0.03593200922606337, 0.0381759629276584, 0.03551175286350059, -0.020382871267200557, -0.007751976804317936, 0.03065374109100252, -0.0033599359622477044, -0.021259304057902204, 0.012809739633839511, 0.05970078809072537, 0.03147388037973146, -0.010120755909162438, -0.06966378731218502, 0.013333530869465168, 0.01642073021232749, -0.018907262782332297, 0.04542549004016403, 0.004352133476810338, 0.021481005619116054, -0.0019338625249506786, 0.0007739938466890813, 0.05200870573123013, 0.01711310650762455, -0.01125442991830596, 0.036915139393967907, -0.02782912376948548, 0.015437391474321898, 0.02114988952148747, 0.0, -0.01582033347061057, 0.014773395667776986, -0.002097169590723648, -0.004207579840014993, 0.012222956434730725, -0.07981133330878366, 0.0011271840381874916, 0.020443008897156823, -0.003685960678923502, -0.026568447678878813, 0.019527469915578025, -0.030585733222321162, -0.052747370094110346, -0.0266245503375618, 0.09873838862814849, -0.010206098797812016, 0.10657558263599434, 0.02462597035916503, -0.02121648870654454, 0.0337994361829705, 0.019873597556444533, 0.0070717106021397445, 0.027173867911027633, 0.013007306337378045, -0.005553855682797124, 0.006783868137997171, -0.019237329209283616, -0.004395611473038109, -0.029700410757173123, -0.0003242016562681503, -0.01568659616769962, 0.02086125195771702, 0.01536521906405614, -0.0312979248206242, 0.002618659434233678, -0.014156615023056703, 0.005620778560734365, 0.13171636036318898, 0.004613618333512715, 0.002585836809341756, 0.0017201839104115414, 0.019291378405156885, 0.02002848590414314, 0.003848273028422758, -0.0019222853646909215, 0.012293557366997549, 0.009996030822127036, 0.01996074256253815, -0.028057952795157493, 0.005944356871518377, -0.0005389383046102703, -0.007032758226283326, 0.00972454989199478, -0.020092992028583896, 0.02785846149730361, 0.04562240394934163, 0.019432788171981324, -0.028392274701487672, 0.0637507334136481, 0.03973092907844773, 0.009001791887935514, -0.00022980581509857124, -0.002531355626229576, -0.02260378189212563, -0.011854098031562177, 0.0016680571006970134, 0.022832579503535396, -0.006303277552324833, 0.005604872216056062, -0.008184308515512762, 0.02251981412963762, 0.02940723102730238, 0.002449071690553728, -0.0008898777005473941, -0.027986480118724066, -0.0499810767323178, 0.008624873781760158, -0.012240642455310972, 0.21084901153443217, 0.08255200616160785, 0.006283119135245286, 0.04393810790668523, 0.031191941196191873, -0.0064951514876559775, 0.014102266061470478, -0.025360051093389027, 0.10558016034119609, -0.0710367059086304, 0.027690114268249407, -0.013749217392392224, -0.012309841221485563, 0.0475787769831349, 0.0046511711757311015, 0.01671946301820671, 0.0047044627322610725, 0.015473905986673779, -0.010339494223940104, 0.06656989527025592, -0.01576625229835325, 0.0285088457773805, 0.06033811583673248, -0.05216236185015259, -0.02190530560000489, 0.022595103516575187, 0.009470937583764404, 0.03845854804194382, -0.004215524619731153, -0.01811692018622846, -0.03948422414294532, 0.03706161192173753, 0.08197919764094116, 0.0017365422374319194, 0.020728037147519477, -0.002917580479522094, -0.03796511022599639, -0.02431964219294336, -0.020287326241534707, -0.005834786478002561, 0.060632445104014984, -0.05097053419227817, -0.08132777960022428, -0.025468023874115897, -0.014318644515208727, -0.03448617607116932, 0.014210644823674262, 0.03327423716819196, 0.016014318075187838, 0.03588783113397211, 0.01795132436114579, 0.050697797557914405, 0.02707897249746283, 0.0, -0.04585701753330142, 0.0615598714403627, -0.005875384111981668, 0.018139396604568824, 0.015515551614488513, 0.015039686718356985, 0.21503818572436537, -0.024076410302478903, 0.09337101160230378, -0.003871611552867048, 0.051000062405118674, -0.035158678640966584, 0.04148240506395825, 0.004419896698151064, 0.010545506256499542, 0.04480197927099438, -0.10623466497893745, -0.053051416752534754, -0.04740315248659471, -0.11124304725868073, -0.03181984787810783, 0.016596485934574183, -0.05217175707548062, 0.0017679302147413185, -0.017821548066256142, 0.01167931283311229, 0.06568567096640693, -0.1134929060466763, 0.053831705489630045, -0.10587099021390192, 0.021628765164071, 0.0692917804713921, -0.04937610986066182, 0.07986878958851583, 0.012788929419378488, -0.040416619721862224, 0.02600299457548185, 0.014871448205767886, 0.040038989802827565, 0.061710482467610635, -0.0025873235649509123, -0.044715575039387265, -0.024018262642204274, -0.04820758331986422, -0.01703418574157292, 0.0033120446647529555, 0.03218775519794658, -0.045023681373955245, -0.12184330088128081, 0.050455218668374664, -0.0067027835376196245, 0.1739446124541399, -0.03787828237032885, -0.0004516201950985384, 0.044937736823763376, 0.060535703005601876, -0.05956446243931686, 0.011475272042549303, -0.0322923280541927, 0.03452910802496246, 0.07014835502227469, 0.06675536385086589, 0.045346905873685485, 0.01644499092487732, 0.012395599272018885, 0.02012689465745807, -0.019093658815579586, 0.06722424010703584, -0.004112079972915786, -0.128362351545877, 0.014771856094982657, 0.07554869444371437, -0.01564844788532143, 0.009840595189389383, 0.07823585805386941, 0.016106899241552758, -0.01595078340328389, 0.010867984628422268, -0.0249377785274337, -0.0058748978119107275, -0.040709199968775873, 0.014081840140019123, 0.008306236681160472, 0.0006485610280032055, 0.002994135354368387, -0.011703644644003891, 0.07449330386486694, 0.0019710414993184015, 0.008521600529061209, -0.02401513693997619, -0.08086990918273541, 0.06309890645523948, 0.03341599691984402, 0.005663170645733963, 0.02659889352662428, -0.008837232562469667
// };

//     // 2) Optimize with raw parameters (p0, u, v)
//     std::vector<double> x_raw;
//     double minf = optimize_params(returns, x_raw);

//     // 3) Map raw parameters back to (ω, α, β)
//     double omega = std::exp(x_raw[0]);
//     double eu    = std::exp(x_raw[1]);
//     double ev    = std::exp(x_raw[2]);
//     double denom = 1.0 + eu + ev;
//     double alpha = eu / denom;
//     double beta  = ev / denom;

//     // 4) Print fitted parameters and objective
//     printf("Optimized objective = %.6f\n", minf);
//     printf("omega = %.8f, alpha = %.6f, beta = %.6f\n", omega, alpha, beta);

//     // 5) Compute the conditional variances
//     std::vector<double> sigmas = calculated_sigma2(returns, {omega, alpha, beta});

//     // 6) Forecast 7-day IV
//     double iv7 = forecast_iv(sigmas, {omega, alpha, beta}, 7);
//     printf("7-day IV = %.4f\n", iv7);

//     return 0;
// }




int main(void){

std::vector<double> returns = {0.03593200922606337, 0.0381759629276584, 0.03551175286350059, -0.020382871267200557, -0.007751976804317936, 0.03065374109100252, -0.0033599359622477044, -0.021259304057902204, 0.012809739633839511, 0.05970078809072537, 0.03147388037973146, -0.010120755909162438, -0.06966378731218502, 0.013333530869465168, 0.01642073021232749, -0.018907262782332297, 0.04542549004016403, 0.004352133476810338, 0.021481005619116054, -0.0019338625249506786, 0.0007739938466890813, 0.05200870573123013, 0.01711310650762455, -0.01125442991830596, 0.036915139393967907, -0.02782912376948548, 0.015437391474321898, 0.02114988952148747, 0.0, -0.01582033347061057, 0.014773395667776986, -0.002097169590723648, -0.004207579840014993, 0.012222956434730725, -0.07981133330878366, 0.0011271840381874916, 0.020443008897156823, -0.003685960678923502, -0.026568447678878813, 0.019527469915578025, -0.030585733222321162, -0.052747370094110346, -0.0266245503375618, 0.09873838862814849, -0.010206098797812016, 0.10657558263599434, 0.02462597035916503, -0.02121648870654454, 0.0337994361829705, 0.019873597556444533, 0.0070717106021397445, 0.027173867911027633, 0.013007306337378045, -0.005553855682797124, 0.006783868137997171, -0.019237329209283616, -0.004395611473038109, -0.029700410757173123, -0.0003242016562681503, -0.01568659616769962, 0.02086125195771702, 0.01536521906405614, -0.0312979248206242, 0.002618659434233678, -0.014156615023056703, 0.005620778560734365, 0.13171636036318898, 0.004613618333512715, 0.002585836809341756, 0.0017201839104115414, 0.019291378405156885, 0.02002848590414314, 0.003848273028422758, -0.0019222853646909215, 0.012293557366997549, 0.009996030822127036, 0.01996074256253815, -0.028057952795157493, 0.005944356871518377, -0.0005389383046102703, -0.007032758226283326, 0.00972454989199478, -0.020092992028583896, 0.02785846149730361, 0.04562240394934163, 0.019432788171981324, -0.028392274701487672, 0.0637507334136481, 0.03973092907844773, 0.009001791887935514, -0.00022980581509857124, -0.002531355626229576, -0.02260378189212563, -0.011854098031562177, 0.0016680571006970134, 0.022832579503535396, -0.006303277552324833, 0.005604872216056062, -0.008184308515512762, 0.02251981412963762, 0.02940723102730238, 0.002449071690553728, -0.0008898777005473941, -0.027986480118724066, -0.0499810767323178, 0.008624873781760158, -0.012240642455310972, 0.21084901153443217, 0.08255200616160785, 0.006283119135245286, 0.04393810790668523, 0.031191941196191873, -0.0064951514876559775, 0.014102266061470478, -0.025360051093389027, 0.10558016034119609, -0.0710367059086304, 0.027690114268249407, -0.013749217392392224, -0.012309841221485563, 0.0475787769831349, 0.0046511711757311015, 0.01671946301820671, 0.0047044627322610725, 0.015473905986673779, -0.010339494223940104, 0.06656989527025592, -0.01576625229835325, 0.0285088457773805, 0.06033811583673248, -0.05216236185015259, -0.02190530560000489, 0.022595103516575187, 0.009470937583764404, 0.03845854804194382, -0.004215524619731153, -0.01811692018622846, -0.03948422414294532, 0.03706161192173753, 0.08197919764094116, 0.0017365422374319194, 0.020728037147519477, -0.002917580479522094, -0.03796511022599639, -0.02431964219294336, -0.020287326241534707, -0.005834786478002561, 0.060632445104014984, -0.05097053419227817, -0.08132777960022428, -0.025468023874115897, -0.014318644515208727, -0.03448617607116932, 0.014210644823674262, 0.03327423716819196, 0.016014318075187838, 0.03588783113397211, 0.01795132436114579, 0.050697797557914405, 0.02707897249746283, 0.0, -0.04585701753330142, 0.0615598714403627, -0.005875384111981668, 0.018139396604568824, 0.015515551614488513, 0.015039686718356985, 0.21503818572436537, -0.024076410302478903, 0.09337101160230378, -0.003871611552867048, 0.051000062405118674, -0.035158678640966584, 0.04148240506395825, 0.004419896698151064, 0.010545506256499542, 0.04480197927099438, -0.10623466497893745, -0.053051416752534754, -0.04740315248659471, -0.11124304725868073, -0.03181984787810783, 0.016596485934574183, -0.05217175707548062, 0.0017679302147413185, -0.017821548066256142, 0.01167931283311229, 0.06568567096640693, -0.1134929060466763, 0.053831705489630045, -0.10587099021390192, 0.021628765164071, 0.0692917804713921, -0.04937610986066182, 0.07986878958851583, 0.012788929419378488, -0.040416619721862224, 0.02600299457548185, 0.014871448205767886, 0.040038989802827565, 0.061710482467610635, -0.0025873235649509123, -0.044715575039387265, -0.024018262642204274, -0.04820758331986422, -0.01703418574157292, 0.0033120446647529555, 0.03218775519794658, -0.045023681373955245, -0.12184330088128081, 0.050455218668374664, -0.0067027835376196245, 0.1739446124541399, -0.03787828237032885, -0.0004516201950985384, 0.044937736823763376, 0.060535703005601876, -0.05956446243931686, 0.011475272042549303, -0.0322923280541927, 0.03452910802496246, 0.07014835502227469, 0.06675536385086589, 0.045346905873685485, 0.01644499092487732, 0.012395599272018885, 0.02012689465745807, -0.019093658815579586, 0.06722424010703584, -0.004112079972915786, -0.128362351545877, 0.014771856094982657, 0.07554869444371437, -0.01564844788532143, 0.009840595189389383, 0.07823585805386941, 0.016106899241552758, -0.01595078340328389, 0.010867984628422268, -0.0249377785274337, -0.0058748978119107275, -0.040709199968775873, 0.014081840140019123, 0.008306236681160472, 0.0006485610280032055, 0.002994135354368387, -0.011703644644003891, 0.07449330386486694, 0.0019710414993184015, 0.008521600529061209, -0.02401513693997619, -0.08086990918273541, 0.06309890645523948, 0.03341599691984402, 0.005663170645733963, 0.02659889352662428, -0.008837232562469667        };        std::vector<double> x = {0.000001, 0.05, 0.9};


double likelihood = optimize_params(returns, x);

std::vector<double> sigmas = calculated_sigma2(returns, x);
double vol = forecast_iv(sigmas, x, 5);
printf("Predicted IV = %f", vol);
return 0;

}


